name: Deploy to Namecheap (SFTP)

on:
  push:
    branches: ["main", "dev", "qa"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Choose remote folder + clean mode
        id: target
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "REMOTE_DIR=public_html" >> $GITHUB_OUTPUT
            echo "CLEAN=false" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "dev" ]; then
            echo "REMOTE_DIR=public_html/dev" >> $GITHUB_OUTPUT
            echo "CLEAN=true" >> $GITHUB_OUTPUT
          else
            echo "REMOTE_DIR=public_html/qa" >> $GITHUB_OUTPUT
            echo "CLEAN=true" >> $GITHUB_OUTPUT
          fi

      - name: Clean dev/qa folders only
        if: ${{ steps.target.outputs.CLEAN == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SFTP_KEY }}
          passphrase: ${{ secrets.SFTP_PASSPHRASE }}
          port: ${{ secrets.SFTP_PORT }}
          script: |
            rm -rf ~/${{ steps.target.outputs.REMOTE_DIR }}/*
            mkdir -p ~/${{ steps.target.outputs.REMOTE_DIR }}

      - name: Upload files via SFTP (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SFTP_KEY }}
          passphrase: ${{ secrets.SFTP_PASSPHRASE }}
          port: ${{ secrets.SFTP_PORT }}
          source: "./*"
          target: "~/${{ steps.target.outputs.REMOTE_DIR }}"
          strip_components: 0
          overwrite: true
          rm: false
