name: Deploy to Namecheap (rsync)

on:
  push:
    branches: ["main", "dev", "qa"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SFTP_KEY }}

      - name: Show loaded key fingerprint
        run: |
          ssh-add -l

      - name: Choose remote folder
        id: target
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "REMOTE_DIR=public_html" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "dev" ]; then
            echo "REMOTE_DIR=public_html/dev" >> $GITHUB_OUTPUT
          else
            echo "REMOTE_DIR=public_html/qa" >> $GITHUB_OUTPUT
          fi

      - name: SSH preflight (force agent)
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
        run: |
          ssh -p "$SFTP_PORT" \
            -o IdentityAgent="$SSH_AUTH_SOCK" \
            -o IdentitiesOnly=yes \
            -o PubkeyAuthentication=yes \
            -o PreferredAuthentications=publickey \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "$SFTP_USER@$SFTP_HOST" "echo SSH_OK && whoami"

      - name: Rsync deploy (sync + deletions)
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          REMOTE_DIR: ${{ steps.target.outputs.REMOTE_DIR }}
        run: |
          set -e

          EXCLUDES=(
            "--exclude=.git/"
            "--exclude=.github/"
            "--exclude=node_modules/"
            "--exclude=README*"
          )

          if [ "${{ github.ref_name }}" = "main" ]; then
            EXCLUDES+=("--exclude=dev/")
            EXCLUDES+=("--exclude=qa/")
          fi

          rsync -az --delete \
            "${EXCLUDES[@]}" \
            -e "ssh -p ${SFTP_PORT} -o IdentityAgent=${SSH_AUTH_SOCK} -o IdentitiesOnly=yes -o PubkeyAuthentication=yes -o PreferredAuthentications=publickey -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ./ "${SFTP_USER}@${SFTP_HOST}:~/${REMOTE_DIR}/"
